name: Deploy Digital Twin

on:
    push:
        branches: [main]
    workflow_dispatch:
        inputs:
            environment:
                description: "Environment to deploy"
                required: true
                default: "dev"
                type: choice
                options:
                    - dev
                    - test
                    - prod

permissions:
    id-token: write
    contents: read

jobs:
    deploy:
        name: Deploy to ${{ github.event.inputs.environment || 'dev' }}
        runs-on: ubuntu-22.04
        environment: ${{ github.event.inputs.environment || 'dev' }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
                  role-session-name: github-actions-deploy
                  aws-region: ${{ secrets.DEFAULT_AWS_REGION }}

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Install uv
              run: |
                  curl -LsSf https://astral.sh/uv/install.sh | sh
                  echo "$HOME/.local/bin" >> $GITHUB_PATH

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_wrapper: false # Important: disable wrapper to get raw outputs

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"
                  cache-dependency-path: frontend/package-lock.json

            - name: Run Deployment Script
              run: |
                  # Set environment variables for the script
                  export AWS_ACCOUNT_ID=${{ secrets.AWS_ACCOUNT_ID }}
                  export DEFAULT_AWS_REGION=${{ secrets.DEFAULT_AWS_REGION }}

                  # Make script executable and run it
                  chmod +x scripts/deploy.sh
                  ./scripts/deploy.sh ${{ github.event.inputs.environment || 'dev' }}
              env:
                  AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

            - name: Get Deployment URLs
              id: deploy_outputs
              working-directory: ./terraform
              run: |
                  terraform workspace select ${{ github.event.inputs.environment || 'dev' }}
                  echo "cloudfront_url=$(terraform output -raw cloudfront_url)" >> $GITHUB_OUTPUT
                  echo "api_url=$(terraform output -raw api_gateway_url)" >> $GITHUB_OUTPUT
                  echo "frontend_bucket=$(terraform output -raw s3_frontend_bucket)" >> $GITHUB_OUTPUT
                  echo "distribution_id=$(terraform output -raw cloudfront_distribution_id)" >> $GITHUB_OUTPUT

            - name: Invalidate CloudFront
              if: ${{ steps.deploy_outputs.outputs.distribution_id != '' }}
              run: |
                  aws cloudfront create-invalidation \
                      --distribution-id ${{ steps.deploy_outputs.outputs.distribution_id }} \
                      --paths "/*"

            - name: Deployment Summary
              run: |
                  echo "âœ… Deployment Complete!"
                  echo "ğŸŒ CloudFront URL: ${{ steps.deploy_outputs.outputs.cloudfront_url }}"
                  echo "ğŸ“¡ API Gateway: ${{ steps.deploy_outputs.outputs.api_url }}"
                  echo "ğŸª£ Frontend Bucket: ${{ steps.deploy_outputs.outputs.frontend_bucket }}"
